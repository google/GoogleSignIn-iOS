name: GSI Chatroom PR Notification

on:
  pull_request:
    types: [assigned, opened, ready_for_review, reopened, review_requested]

jobs:
  notify-pull-request:
    runs-on: ubuntu-latest
    steps:
    - name: Pull Request Details
      run: |
        echo "Pull Request: ${GITHUB_EVENT_PULL_REQUEST_TITLE}"
        echo "Author: ${GITHUB_EVENT_PULL_REQUEST_USER_LOGIN}"
      env:
        GITHUB_EVENT_PULL_REQUEST_TITLE: ${{ github.event.pull_request.title }}
        GITHUB_EVENT_PULL_REQUEST_USER_LOGIN: ${{ github.event.pull_request.user.login }}

    - name: Google Chat Notification
      run: |
        curl --location --request POST '${{ secrets.WEBHOOK_URL }}' \
        --header 'Content-Type: application/json' \
        --data-raw '{
          "cards": [
            {
              "header": {
                "title": "Pull request notification",
                "subtitle": "Pull request: #${{ github.event.pull_request.number }}"
              },
              "sections": [
                {
                  "widgets": [
                    {
                      "keyValue": {
                        "topLabel": "Repo",
                        "content": "${GITHUB_EVENT_PULL_REQUEST_HEAD_REPO_FULL_NAME}"
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "Title",
                        "content": "${GITHUB_EVENT_PULL_REQUEST_TITLE}"
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "Creator",
                        "content": "${GITHUB_EVENT_PULL_REQUEST_USER_LOGIN}"
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "State",
                        "content": "${{ github.event.pull_request.state }}"
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "Assignees",
                        "content": "- ${{ join(github.event.pull_request.assignees.*.login, ', ') }}"
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "Reviewers",
                        "content": "- ${{ join(github.event.pull_request.requested_reviewers.*.login, ', ') }}"
                      }
                    },
                    {
                      "keyValue": {
                        "topLabel": "Labels",
                        "content": "- ${{ join(github.event.pull_request.labels.*.name, ', ') }}"
                      }
                    },
                    {
                      "buttons": [
                        {
                          "textButton": {
                            "text": "Open Pull Request",
                            "onClick": {
                              "openLink": {
                                "url": "${GITHUB_EVENT_PULL_REQUEST_HTML_URL}"
                              }
                            }
                          }
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }'
      env:
        GITHUB_EVENT_PULL_REQUEST_HEAD_REPO_FULL_NAME: ${{ github.event.pull_request.head.repo.full_name }}
        GITHUB_EVENT_PULL_REQUEST_TITLE: ${{ github.event.pull_request.title }}
        GITHUB_EVENT_PULL_REQUEST_USER_LOGIN: ${{ github.event.pull_request.user.login }}
        GITHUB_EVENT_PULL_REQUEST_HTML_URL: ${{ github.event.pull_request.html_url }}
